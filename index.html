<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pithos | Forensic Auditor</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #000; --fg: #fff; --dim: #666; --border: 1px solid #fff; --accent: #00ff41; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--fg); font-family: 'JetBrains Mono', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header { padding: 10px 20px; border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; background: #000; z-index: 10; }
        h1 { margin: 0; font-size: 1.2rem; }
        
        .sys-stat { font-size: 0.7rem; color: #666; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; background: #333; border-radius: 50%; }
        .dot.ready { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

        #workspace { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* VIEWER */
        #doc-view { 
            flex: 1; padding: 20px; overflow-y: auto; border-right: var(--border); 
            font-size: 0.8rem; line-height: 1.6; color: #ccc; white-space: pre-wrap;
            user-select: text; background: #000;
        }

        /* CONTROLS */
        #audit-panel { width: 350px; background: #0a0a0a; display: flex; flex-direction: column; border-left: var(--border); }
        .panel-content { flex: 1; padding: 20px; overflow-y: auto; }
        
        .card { border: var(--border); padding: 15px; margin-bottom: 15px; background: #111; }
        .label { font-size: 0.7rem; color: #888; display: block; margin-bottom: 5px; }
        .val-display { font-size: 1.2rem; font-weight: bold; color: #fff; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .evidence-text { font-size: 0.7rem; color: #888; margin-top: 5px; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .hl-money { color: #ffd700; cursor: pointer; text-decoration: underline; font-weight: bold; }
        .hl-money:hover { background: rgba(255, 215, 0, 0.2); }
        .hl-user { color: #00ffff; cursor: pointer; text-decoration: underline; font-weight: bold; }
        .hl-user:hover { background: rgba(0, 255, 255, 0.2); }
        
        .redacted { color: #222; background: #111; letter-spacing: -3px; cursor: help; }
        .redacted:hover { background: #222; color: #444; }
        .revealed { color: #ccc; background: transparent; letter-spacing: normal; animation: fadeIn 0.5s; border-left: 2px solid #555; padding-left: 5px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .active-line { color: #fff; margin: 2px 0; background: #111; padding: 2px 0; border-left: 2px solid var(--accent); padding-left: 8px; }

        .verdict-box { text-align: center; padding: 10px; margin-top: 10px; border: 1px solid #333; }
        .scam { color: #ff0055; border-color: #ff0055; }
        .safe { color: var(--accent); border-color: var(--accent); }

        .btn-action { width: 100%; padding: 12px; background: #333; color: #fff; border: 1px solid #fff; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-action:hover { background: #fff; color: #000; }

        #drop-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 20; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-upload {
            background: #333; color: #888; border: 1px solid #666; padding: 15px 30px;
            font-weight: bold; font-size: 1.2rem; cursor: not-allowed; border-radius: 4px; margin-top: 20px; transition: 0.3s;
        }
        .btn-upload.active { background: var(--accent); color: #000; border-color: var(--accent); cursor: pointer; }
        #loading { display: none; color: var(--accent); position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); z-index: 30; text-align: center;}

        @media (max-width: 768px) {
            #workspace { flex-direction: column; }
            #doc-view { height: 50%; border-right: none; border-bottom: var(--border); }
            #audit-panel { height: 50%; width: 100%; border-left: none; }
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-search-dollar" style="color:var(--accent);"></i>
            <h1>FORENSIC AUDITOR</h1>
        </div>
        <div class="sys-stat"><span id="stat-text">BOOTING...</span><div id="stat-dot" class="dot"></div></div>
    </header>

    <div id="workspace">
        <div id="doc-view">
            <div style="text-align:center; color:#444; margin-top:50px;">// SECURE VIEWER //</div>
        </div>

        <div id="audit-panel">
            <div class="panel-content">
                <div class="card">
                    <span class="label">TARGET (è‡ªå‹•å…¥åŠ›/ç·¨é›†å¯)</span>
                    <input type="text" id="project-name" placeholder="äº‹æ¥­åã‚’å…¥åŠ›..." style="width:100%; background:transparent; border:none; color:#fff; font-family:inherit; border-bottom:1px dashed #444;">
                </div>
                
                <div class="card" style="border-color: #ffd700;">
                    <span class="label">1. BUDGET (äºˆç®—)</span>
                    <div id="disp-budget" class="val-display">0</div>
                    <div id="ev-budget" class="evidence-text">...</div>
                </div>

                <div class="card" style="border-color: #00ffff;">
                    <span class="label">2. USERS (äººæ•°)</span>
                    <div id="disp-user" class="val-display">0</div>
                    <div id="ev-user" class="evidence-text">...</div>
                </div>

                <div id="verdict-area" class="verdict-box" style="display:none;">
                    <div style="font-size:0.7rem;">D_INDEX</div>
                    <div id="d-val" style="font-size:2.5rem; font-weight:bold;">0.0</div>
                    <div id="d-res">---</div>
                </div>
            </div>
            
            <div style="padding:20px; border-top:var(--border);">
                <button class="btn-action" py-click="export_report">
                    <i class="fas fa-file-export"></i> GENERATE REPORT
                </button>
                <button class="btn-action" style="background:#000; color:#888; border-color:#444;" onclick="location.reload()">RESET</button>
            </div>
        </div>

        <div id="drop-overlay">
            <i class="fas fa-file-shield" style="font-size:4rem; color:#666;"></i>
            <h2 style="margin-top:20px; color:#ccc;">DROP PDF</h2>
            <button id="btn-select" class="btn-upload" disabled onclick="document.getElementById('file-in').click()">INITIALIZING...</button>
            <input type="file" id="file-in" style="display:none;" accept="application/pdf">
        </div>
        <div id="loading"><i class="fas fa-cog fa-spin" style="font-size:2rem;"></i><br><br>CONTEXT ANALYSIS...</div>
    </div>

    <!-- JS -->
    <script>
        function revealText(el, originalText) {
            el.innerText = originalText; el.className = "revealed"; el.onclick = null;
        }

        const fileIn = document.getElementById('file-in');
        fileIn.onchange = (e) => { if (e.target.files[0]) loadPDF(e.target.files[0]); };

        async function loadPDF(file) {
            // Use filename as initial project name guess
            document.getElementById('project-name').value = file.name.replace(".pdf", "");
            document.getElementById('drop-overlay').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                let text = "";
                const max = Math.min(pdf.numPages, 50);
                
                for (let i = 1; i <= max; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    let lastY = -1;
                    let pageText = "";
                    for (let item of content.items) {
                        if (lastY != -1 && Math.abs(item.transform[5] - lastY) > 5) pageText += "\n";
                        else if (lastY != -1) pageText += " ";
                        pageText += item.str;
                        lastY = item.transform[5];
                    }
                    text += pageText + "\n";
                }
                window.py_process_secure(text);
            } catch (e) { alert("Error: " + e); location.reload(); }
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
        }

        function systemReady() {
            document.getElementById('stat-text').innerText = "SYSTEM READY";
            document.getElementById('stat-text').style.color = "#00ff41";
            document.getElementById('stat-dot').classList.add('ready');
            const btn = document.getElementById('btn-select');
            btn.disabled = false; btn.innerText = "ğŸ“‚ OPEN FILE"; btn.classList.add('active');
        }
    </script>

    <!-- PYTHON -->
    <script type="py">
        from pyscript import document
        from pyodide.ffi import create_proxy
        import js, re
        from datetime import datetime
        
        current_budget = 0
        current_users = 0
        evidence_budget = ""
        evidence_users = ""

        KW = ["äºˆç®—", "æ±ºç®—", "äº‹æ¥­", "æ¦‚è¦", "ç›®çš„", "æˆæœ", "åˆè¨ˆ", "æ­³å‡º", "æ­³å…¥", "å†…è¨³", "è²»ç”¨", "å¯¾è±¡", "ã€", "ã€‘", "â– ", "â—", "ãƒ»", "å††", "äºº", "å¹´åº¦", "åŸºé‡‘", "ç¹°å…¥", "è£œæ­£", "å§”è¨—", "å·¥äº‹"]
        
        re_money = re.compile(r'([0-9,]+(å…†|å„„|ä¸‡|åƒ)?å††)')
        re_ppl = re.compile(r'([0-9,]+(äºº|å|ä¸–å¸¯))')

        def process_secure(raw_text):
            lines = raw_text.split('\n')
            safe_html = ""
            
            for line in lines:
                s_line = line.strip()
                if not s_line: continue
                
                has_m = re_money.search(s_line)
                has_p = re_ppl.search(s_line)
                safe_text = s_line.replace('"', '&quot;').replace("'", "&#39;")

                if has_m or has_p:
                    proc = s_line
                    
                    def repl_m(m):
                        val = parse_jp_money(m.group(0))
                        if val < 100000: return m.group(0)
                        return f'<span class="hl-money" onclick="window.set_budget({val}, \'{safe_text}\')">{m.group(0)}</span>'
                    
                    def repl_p(m):
                        val = parse_num(m.group(0))
                        return f'<span class="hl-user" onclick="window.set_user({val}, \'{safe_text}\')">{m.group(0)}</span>'
                    
                    proc = re_money.sub(repl_m, proc)
                    proc = re_ppl.sub(repl_p, proc)
                    safe_html += f"<div class='active-line'>{proc}</div>"
                
                elif any(k in s_line for k in KW):
                    safe_html += f"<div class='context-line'>{s_line}</div>"
                else:
                    mask = "â–‘" * min(len(s_line), 40)
                    safe_html += f"<div class='redacted' onclick=\"revealText(this, '{safe_text}')\">{mask}</div>"

            document.getElementById('doc-view').innerHTML = safe_html
            document.getElementById('loading').style.display = 'none'

        def parse_jp_money(s):
            s = s.replace(",","").replace("å††","")
            unit = 1
            if "å…†" in s: unit=1000000000000; s=s.replace("å…†","")
            if "å„„" in s: unit=100000000; s=s.replace("å„„","")
            if "ä¸‡" in s: unit=10000; s=s.replace("ä¸‡","")
            try: return float(s) * unit
            except: return 0

        def parse_num(s):
            s = s.replace(",","").replace("äºº","").replace("å","").replace("ä¸–å¸¯","")
            try: return float(s)
            except: return 0

        def set_budget_py(val, text):
            global current_budget, evidence_budget
            current_budget = val
            evidence_budget = text
            document.getElementById('disp-budget').innerText = f"Â¥{int(val):,}"
            document.getElementById('ev-budget').innerText = f"\"{text}\""
            calc()

        def set_user_py(val, text):
            global current_users, evidence_users
            current_users = val
            evidence_users = text
            document.getElementById('disp-user').innerText = f"{int(val):,} äºº"
            document.getElementById('ev-user').innerText = f"\"{text}\""
            calc()

        def calc():
            if current_users == 0: return
            d = (current_budget / 30000000) / (current_users / 72000)
            el_val = document.getElementById('d-val')
            el_res = document.getElementById('d-res')
            box = document.getElementById('verdict-area')
            box.style.display = 'block'
            el_val.innerText = f"{d:.1f}"
            if d > 50:
                el_res.innerText = "ğŸš¨ SCAM"
                box.className = "verdict-box scam"
            elif d > 10:
                el_res.innerText = "âš ï¸ CRITICAL"
                box.className = "verdict-box scam"
            else:
                el_res.innerText = "âœ… SUSTAINABLE"
                box.className = "verdict-box safe"

        def export_report(e):
            p_name = document.getElementById('project-name').value
            d_val = float(document.getElementById('d-val').innerText)
            
            # --- AUTO COMMENT LOGIC ---
            if d_val > 50:
                rank = "ğŸ¥‡ WORST 1"
                status = "SCAM (è©æ¬ºãƒ¬ãƒ™ãƒ«)"
                comment = "SBCMåŸºæº–ã‚’å¤§å¹…ã«é€¸è„±ã—ã¦ã„ã¾ã™ã€‚ä½æ°‘1äººã‚ãŸã‚Šã®è² æ‹…ãŒç•°å¸¸ã§ã‚ã‚Šã€ç›´ã¡ã«ç›£æŸ»ãŒå¿…è¦ã§ã™ã€‚å…¸å‹çš„ãªã€ãƒã‚³ãƒ¢ãƒã€ã¾ãŸã¯ã€ä¸­æŠœãã€ã®ç–‘ã„ãŒã‚ã‚Šã¾ã™ã€‚"
            elif d_val > 10:
                rank = "ğŸ¥ˆ CRITICAL"
                status = "High Distortion (æ­ªã¿)"
                comment = "è²»ç”¨å¯¾åŠ¹æœãŒæ¥µã‚ã¦ä½ã„ã§ã™ã€‚ç›®çš„ã«å¯¾ã—ã¦äºˆç®—ãŒéå¤§ã‹ã€ã‚ã‚‹ã„ã¯å—ç›Šè€…ãŒé™å®šçš„ã™ãã¾ã™ã€‚äº‹æ¥­ã®ç¸®å°ã¾ãŸã¯å»ƒæ­¢ã‚’æ¤œè¨ã™ã¹ããƒ¬ãƒ™ãƒ«ã§ã™ã€‚"
            elif d_val < 1:
                rank = "ğŸ’ EXCELLENT"
                status = "High Efficiency (é«˜åŠ¹ç‡)"
                comment = "æ¥µã‚ã¦ä½ã‚³ã‚¹ãƒˆã§å¤šãã®å¸‚æ°‘ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã§ãã¦ã„ã¾ã™ã€‚ä»–ã®è‡ªæ²»ä½“ã®æ¨¡ç¯„ã¨ãªã‚‹ã€ç¥é‹å–¶ã€ã§ã™ã€‚"
            else:
                rank = "âœ… STANDARD"
                status = "Normal Range (é©æ­£)"
                comment = "SBCMåŸºæº–å†…ã§ã™ã€‚ã‚¤ãƒ³ãƒ•ãƒ©ã¨ã—ã¦é©æ­£ãªã‚³ã‚¹ãƒˆãƒãƒ©ãƒ³ã‚¹ãŒä¿ãŸã‚Œã¦ã„ã¾ã™ã€‚"

            # REPORT TEMPLATE
            md = f"""# ğŸ›ï¸ SBCM Audit Report
**Date:** {datetime.now().strftime("%Y-%m-%d %H:%M")}
**Project:** {p_name}
**Auditor:** Pithos Secure Module

---

## {rank}: {p_name}
**ï½ {status} ï½**

*   **æ±ºç®—é¡:** Â¥{int(current_budget):,}
*   **æ¨å®šå—ç›Šè€…æ•°:** {int(current_users):,} äºº
*   **æ­ªã¿æŒ‡æ•° ($D$):** **{d_val}**
*   **1äººã‚ãŸã‚Šã‚³ã‚¹ãƒˆ:** Â¥{int(current_budget/current_users):,} / äºº

### ğŸ’¬ ç›£æŸ»å®˜ã‚³ãƒ¡ãƒ³ãƒˆ
{comment}

---

## ğŸ” Evidence (æŠ½å‡ºæ ¹æ‹ )
> **äºˆç®—ã‚½ãƒ¼ã‚¹:**
> "{evidence_budget}"
>
> **äººæ•°ã‚½ãƒ¼ã‚¹:**
> "{evidence_users}"

---
*Generated by Pithos OS*
"""
            js.downloadFile(f"SBCM_Audit_{p_name}.md", md)

        js.window.py_process_secure = create_proxy(process_secure)
        js.window.set_budget = create_proxy(set_budget_py)
        js.window.set_user = create_proxy(set_user_py)
        js.systemReady()
    </script>
</body>
</html>