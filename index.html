<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pithos | Secure Auditor</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #000; --fg: #fff; --dim: #666; --border: 1px solid #fff; --accent: #00ff41; --mask: #222; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--fg); font-family: 'JetBrains Mono', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header { padding: 10px 20px; border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; background: #000; z-index: 10; }
        h1 { margin: 0; font-size: 1.2rem; }
        
        .sys-stat { font-size: 0.7rem; color: #666; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; background: #333; border-radius: 50%; }
        .dot.ready { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

        #workspace { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* VIEWER */
        #doc-view { 
            flex: 1; padding: 20px; overflow-y: auto; border-right: var(--border); 
            font-size: 0.8rem; line-height: 1.6; color: #aaa; white-space: pre-wrap;
            user-select: none; -webkit-user-select: none;
            background: #000;
        }

        /* CONTROLS */
        #audit-panel { width: 350px; background: #0a0a0a; display: flex; flex-direction: column; border-left: var(--border); }
        .panel-content { flex: 1; padding: 20px; overflow-y: auto; }
        
        .card { border: var(--border); padding: 15px; margin-bottom: 15px; background: #111; }
        .label { font-size: 0.7rem; color: #888; display: block; margin-bottom: 5px; }
        .val-display { font-size: 1.2rem; font-weight: bold; color: #fff; border-bottom: 1px solid #444; padding-bottom: 5px; }
        
        .hl-money { color: #ffd700; cursor: pointer; text-decoration: underline; font-weight: bold; }
        .hl-money:hover { background: #ffd700; color: #000; }
        .hl-user { color: #00ffff; cursor: pointer; text-decoration: underline; font-weight: bold; }
        .hl-user:hover { background: #00ffff; color: #000; }
        
        /* Redaction Style */
        .redacted { color: #222; background: #111; letter-spacing: -3px; word-break: break-all; margin: 2px 0; }
        /* Context Line Style */
        .context-line { color: #888; border-left: 2px solid #333; padding-left: 8px; margin: 2px 0; }

        .verdict-box { text-align: center; padding: 10px; margin-top: 10px; border: 1px solid #333; }
        .scam { color: #ff0055; border-color: #ff0055; }
        .safe { color: var(--accent); border-color: var(--accent); }

        .btn-action { width: 100%; padding: 12px; background: #333; color: #fff; border: 1px solid #fff; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-action:hover { background: #fff; color: #000; }

        #drop-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 20; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-upload {
            background: #333; color: #888; border: 1px solid #666; padding: 15px 30px;
            font-weight: bold; font-size: 1.2rem; cursor: not-allowed; border-radius: 4px; margin-top: 20px; transition: 0.3s;
        }
        .btn-upload.active { background: var(--accent); color: #000; border-color: var(--accent); cursor: pointer; }
        
        #loading { display: none; color: var(--accent); position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); z-index: 30; text-align: center;}

        @media (max-width: 768px) {
            #workspace { flex-direction: column; }
            #doc-view { height: 50%; border-right: none; border-bottom: var(--border); }
            #audit-panel { height: 50%; width: 100%; border-left: none; }
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-shield-alt" style="color:var(--accent);"></i>
            <h1>SECURE AUDITOR</h1>
        </div>
        <div class="sys-stat">
            <span id="stat-text">BOOTING...</span>
            <div id="stat-dot" class="dot"></div>
        </div>
    </header>

    <div id="workspace">
        <div id="doc-view">
            <div style="text-align:center; color:#444; margin-top:50px;">
                // SECURE VIEWER //<br>
                Drag & Drop PDF here
            </div>
        </div>

        <div id="audit-panel">
            <div class="panel-content">
                <div class="card">
                    <span class="label">TARGET FILE</span>
                    <input type="text" id="doc-name" placeholder="Waiting for file..." disabled style="width:100%; background:transparent; border:none; color:#888;">
                </div>

                <div class="card" style="border-color: #ffd700;">
                    <span class="label">1. BUDGET (‰∫àÁÆó)</span>
                    <div id="disp-budget" class="val-display">0</div>
                    <div style="font-size:0.7rem; color:#ffd700; margin-top:5px;">[TAP YELLOW TEXT]</div>
                </div>

                <div class="card" style="border-color: #00ffff;">
                    <span class="label">2. USERS (‰∫∫Êï∞)</span>
                    <div id="disp-user" class="val-display">0</div>
                    <div style="font-size:0.7rem; color:#00ffff; margin-top:5px;">[TAP BLUE TEXT]</div>
                </div>

                <div id="verdict-area" class="verdict-box" style="display:none;">
                    <div style="font-size:0.7rem;">D_INDEX</div>
                    <div id="d-val" style="font-size:2.5rem; font-weight:bold;">0.0</div>
                    <div id="d-res">---</div>
                </div>
            </div>
            
            <div style="padding:20px; border-top:var(--border);">
                <button class="btn-action" py-click="export_md"><i class="fas fa-download"></i> EXPORT</button>
                <button class="btn-action" style="background:#000; color:#888; border-color:#444;" onclick="location.reload()">RESET</button>
            </div>
        </div>

        <div id="drop-overlay">
            <i class="fas fa-file-shield" style="font-size:4rem; color:#666;"></i>
            <h2 style="margin-top:20px; color:#ccc;">DROP PDF</h2>
            <button id="btn-select" class="btn-upload" disabled onclick="document.getElementById('file-in').click()">INITIALIZING...</button>
            <input type="file" id="file-in" style="display:none;" accept="application/pdf">
        </div>
        
        <div id="loading"><i class="fas fa-cog fa-spin" style="font-size:2rem;"></i><br><br>CONTEXT ANALYSIS...</div>
    </div>

    <!-- JS -->
    <script>
        const fileIn = document.getElementById('file-in');
        fileIn.onchange = (e) => { if (e.target.files[0]) loadPDF(e.target.files[0]); };

        async function loadPDF(file) {
            document.getElementById('doc-name').value = file.name;
            document.getElementById('drop-overlay').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buffer).promise;
                let text = "";
                const max = Math.min(pdf.numPages, 50); // Increased page limit
                
                for (let i = 1; i <= max; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    
                    // Improved layout retention
                    let lastY = -1;
                    let pageText = "";
                    for (let item of content.items) {
                        if (lastY != -1 && Math.abs(item.transform[5] - lastY) > 5) {
                            pageText += "\n";
                        } else if (lastY != -1) {
                            pageText += " ";
                        }
                        pageText += item.str;
                        lastY = item.transform[5];
                    }
                    text += pageText + "\n";
                }
                
                window.py_process_secure(text);

            } catch (e) {
                alert("Error: " + e); location.reload();
            }
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
        }

        function systemReady() {
            document.getElementById('stat-text').innerText = "SYSTEM READY";
            document.getElementById('stat-text').style.color = "#00ff41";
            document.getElementById('stat-dot').classList.add('ready');
            const btn = document.getElementById('btn-select');
            btn.disabled = false; btn.innerText = "üìÇ OPEN FILE"; btn.classList.add('active');
        }
    </script>

    <!-- PYTHON -->
    <script type="py">
        from pyscript import document
        from pyodide.ffi import create_proxy
        import js, re
        
        current_budget = 0
        current_users = 0

        # Regex
        re_money = re.compile(r'([0-9,]+(ÂÖÜ|ÂÑÑ|‰∏á|ÂçÉ)?ÂÜÜ)')
        re_ppl = re.compile(r'([0-9,]+(‰∫∫|Âêç|‰∏ñÂ∏Ø))')
        
        # Context Keywords (Ë°åÊîøÊñáÊõ∏„Å´„Çà„Åè„ÅÇ„ÇãÂçòË™û)
        KEYWORDS = ["‰∫àÁÆó", "Ê±∫ÁÆó", "‰∫ãÊ•≠", "Ê¶ÇË¶Å", "ÁõÆÁöÑ", "ÊàêÊûú", "ÂêàË®à", "Ê≠≥Âá∫", "Ê≠≥ÂÖ•", "ÂÜÖË®≥", "Ë≤ªÁî®", "ÂØæË±°", "„Äê", "„Äë", "‚ñ†", "‚óè"]

        def process_secure(raw_text):
            lines = raw_text.split('\n')
            safe_html = ""
            
            def repl_m(m):
                val = parse_jp_money(m.group(0))
                if val < 100000: return m.group(0) # Â∞èÈä≠„ÅØÁÑ°Ë¶ñ
                return f'<span class="hl-money" onclick="window.set_budget({val})">{m.group(0)}</span>'

            def repl_p(m):
                val = parse_num(m.group(0))
                return f'<span class="hl-user" onclick="window.set_user({val})">{m.group(0)}</span>'

            for line in lines:
                s_line = line.strip()
                if not s_line: continue
                
                has_m = re_money.search(s_line)
                has_p = re_ppl.search(s_line)
                
                # Check for context keywords
                is_context = False
                for kw in KEYWORDS:
                    if kw in s_line:
                        is_context = True
                        break
                
                # Short lines are often headers or table items, keep them
                if len(s_line) < 30:
                    is_context = True

                if has_m or has_p:
                    # 1. Êï∞Â≠ó„Åå„ÅÇ„ÇãË°å -> „Éè„Ç§„É©„Ç§„Éà„Åó„Å¶Ë°®Á§∫
                    processed = s_line
                    processed = re_money.sub(repl_m, processed)
                    processed = re_ppl.sub(repl_p, processed)
                    safe_html += f"<div>{processed}</div>"
                    
                elif is_context:
                    # 2. ÊñáËÑà„Åå„ÅÇ„ÇãË°å -> „Åù„ÅÆ„Åæ„ÅæË°®Á§∫ (Context Line)
                    safe_html += f"<div class='context-line'>{s_line}</div>"
                    
                else:
                    # 3. „Åù„Çå‰ª•Â§ñ -> ÈªíÂ°ó„Çä (Redact)
                    mask = "‚ñë" * min(len(s_line), 40)
                    safe_html += f"<div class='redacted'>{mask}</div>"

            document.getElementById('doc-view').innerHTML = safe_html
            document.getElementById('loading').style.display = 'none'

        def parse_jp_money(s):
            s = s.replace(",","").replace("ÂÜÜ","")
            unit = 1
            if "ÂÖÜ" in s: unit=1000000000000; s=s.replace("ÂÖÜ","")
            if "ÂÑÑ" in s: unit=100000000; s=s.replace("ÂÑÑ","")
            if "‰∏á" in s: unit=10000; s=s.replace("‰∏á","")
            try: return float(s) * unit
            except: return 0

        def parse_num(s):
            s = s.replace(",","").replace("‰∫∫","").replace("Âêç","").replace("‰∏ñÂ∏Ø","")
            try: return float(s)
            except: return 0

        def set_budget_py(val):
            global current_budget
            current_budget = val
            document.getElementById('disp-budget').innerText = f"¬•{int(val):,}"
            calc()

        def set_user_py(val):
            global current_users
            current_users = val
            document.getElementById('disp-user').innerText = f"{int(val):,} ‰∫∫"
            calc()

        def calc():
            if current_users == 0: return
            d = (current_budget / 30000000) / (current_users / 72000)
            
            el_val = document.getElementById('d-val')
            el_res = document.getElementById('d-res')
            box = document.getElementById('verdict-area')
            
            box.style.display = 'block'
            el_val.innerText = f"{d:.1f}"
            
            if d > 10:
                el_res.innerText = "üö® SCAM"
                box.className = "verdict-box scam"
            else:
                el_res.innerText = "‚úÖ SAFE"
                box.className = "verdict-box safe"

        def export_md(e):
            fname = document.getElementById('doc-name').value
            d_val = document.getElementById('d-val').innerText
            md = f"# Audit: {fname}\n* Budget: {int(current_budget):,}\n* Users: {int(current_users):,}\n* D_Index: {d_val}\n\n(Generated by Pithos)"
            js.downloadFile(f"Audit_{d_val}.md", md)

        js.window.py_process_secure = create_proxy(process_secure)
        js.window.set_budget = create_proxy(set_budget_py)
        js.window.set_user = create_proxy(set_user_py)
        js.systemReady()
    </script>
</body>
</html>